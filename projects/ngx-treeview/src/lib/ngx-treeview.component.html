<div *ngIf="data && data.length > 0" class="ngx-treeview">
    <mat-tree [dataSource]="dataSource" [treeControl]="treeControl">
        <mat-tree-node *matTreeNodeDef="let treeNode" matTreeNodePadding fxLayout="column" fxLayoutAlign="start">
            <ng-container
                *ngTemplateOutlet="treeTemplate;context:{treeNode:treeNode,options:options,matTreeNodeToggle:false}">
            </ng-container>
        </mat-tree-node>
        <mat-tree-node *matTreeNodeDef="let treeNode; when: hasChild" matTreeNodePadding fxLayout="column"
            fxLayoutAlign="start">
            <ng-container
                *ngTemplateOutlet="treeTemplate;context:{treeNode:treeNode,options:options,matTreeNodeToggle:true}">
            </ng-container>
        </mat-tree-node>
    </mat-tree>
</div>

<ng-template #treeTemplate let-options="options" let-treeNode="treeNode" let-matTreeNodeToggle="matTreeNodeToggle">
    <div [fxLayout]="options?.iconPosition == 'prefix' ? 'row' : 'row-reverse'"
        [fxLayoutAlign]="options?.iconPosition == 'prefix' ? 'start center' : 'space-between'" 
        class="ngx-treeview-node" [ngClass]="matTreeNodeToggle ? 'ngx-treeview-expandable-node' :''">
        <mat-icon *ngIf="options?.showExpandCollapseIcon" (click)="toggleTree(treeNode,matTreeNodeToggle)"
            class="ngx-treeview-expand-collapse-icon" [ngClass]="!matTreeNodeToggle ? 'hidden' :''">
            {{getIcon(treeNode,matTreeNodeToggle)}}
        </mat-icon>
        <ng-container *ngIf="!template">
            <ng-container
                [ngTemplateOutlet]="nodeTemplate || defaultNodeTemplate"
                [ngTemplateOutletContext]="{
                    matTreeNodeToggle: matTreeNodeToggle,
                    treeNode: treeNode,
                    options: options
                }">
            </ng-container>
        </ng-container>
        <ngx-treeview-dynamic-template *ngIf="template" [template]="template" [treeControl]="treeControl"
            [nodeData]="treeNode" (callbackFn)="callbackFn($event)"></ngx-treeview-dynamic-template>
    </div>
</ng-template>

<ng-template #defaultNodeTemplate 
    let-matTreeNodeToggle="matTreeNodeToggle" 
    let-treeNode="treeNode"
    let-options="options">
    <div fxLayout="row" class="ngx-treeview-node-content">
        <div *ngIf="options?.showCheckbox">
            <mat-checkbox *ngIf="!matTreeNodeToggle" class="ngx-treeview-checkbox-node"
                [checked]="checkboxSelection.isSelected(treeNode)" (change)="leafItemSelectionToggle(treeNode)">
            </mat-checkbox>
            <mat-checkbox *ngIf="matTreeNodeToggle" [checked]="descendantsAllSelected(treeNode)"
                [indeterminate]="descendantsPartiallySelected(treeNode)" (change)="itemSelectionToggle(treeNode)">
            </mat-checkbox>
        </div>
        <div (callbackFn)="callbackFn(treeNode?.node)"
            [fxLayout]="options?.nodeIconPosition == 'prefix' ? 'row' : 'row-reverse'" fxLayoutAlign="start center">
            <img (click)="toggleTree(treeNode,matTreeNodeToggle)" *ngIf="treeNode?.node?.iconPath"
                class="ngx-treeview-icon" [src]="treeNode?.node?.iconPath" alt="ngx-treeview-icon">
            <div fxLayout="row" fxLayoutAlign="start center">
                <div (click)="toggleTree(treeNode,matTreeNodeToggle)" class="ngx-treeview-node-label">
                    {{treeNode?.node[options?.nodeNameProperty]}}
                </div>
                <div class="ngx-treeview-count" *ngIf="matTreeNodeToggle && options?.showChildCount">
                    {{ getCount(treeNode)}}
                </div>
            </div>
        </div>
    </div>
</ng-template>